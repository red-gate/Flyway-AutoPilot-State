name: GitHub - State Based Pipeline Validation Workflow (Docker-native)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-validation]
  pull_request:
    branches:
      - release
      - 'feature/*'

jobs:
  setup-validation-environment:
    name: Spin Up SQL Server Container
    runs-on: "self-hosted"
    env:
      IMAGE_NAME: "${{ vars.IMAGE_NAME }}"
      SA_PASSWORD: "DatabaseDevOps!"
      HOST_PORT: "${{ vars.CONTAINER_PORT }}"
      BASE_CONTAINER_NAME: "${{ vars.RGCLONE_CONTAINER_NAME }}"
      CONTAINER_NAME: "${{ vars.CONTAINER_NAME }}-${{ github.run_number }}"
      DB_INIT_SCRIPT: "${{ github.workspace }}/Scripts/CreateAutopilotDatabases.sql"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Docker availability
        run: docker version || echo "Docker not found, please install before running this workflow."

      - name: Check if port is in use and free it
        run: |
          echo "Checking if port $HOST_PORT is in use..."
          if lsof -i :$HOST_PORT &>/dev/null; then
            echo "Port $HOST_PORT is in use. Checking for container..."
            EXISTING_CONTAINER=$(docker ps --filter "publish=$HOST_PORT" --format "{{.Names}}")
            if [ -n "$EXISTING_CONTAINER" ]; then
              echo "Stopping and removing container using port $HOST_PORT ($EXISTING_CONTAINER)..."
              docker stop "$EXISTING_CONTAINER" || true
              docker rm "$EXISTING_CONTAINER" || true
            else
              echo "No Docker container found using port $HOST_PORT, killing any process..."
              PID=$(lsof -ti :$HOST_PORT)
              kill -9 $PID || true
            fi
          else
            echo "Port $HOST_PORT is free."
          fi

      - name: Pull Docker Image
        run: docker pull $IMAGE_NAME
      
      - name: Start Docker Container
        run: |
          echo "Starting container on port $HOST_PORT..."
          docker run -d --rm \
            --name $CONTAINER_NAME \
            -e "ACCEPT_EULA=Y" \
            -e "SA_PASSWORD=$SA_PASSWORD" \
            -p $HOST_PORT:1433 \
            $IMAGE_NAME

      - name: Install mssql-tools inside container as root
        run: |
          docker exec -u root $CONTAINER_NAME bash -c "\
            apt-get update && \
            apt-get install -y curl gnupg2 apt-transport-https && \
            curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - && \
            curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list > /etc/apt/sources.list.d/mssql-tools.list && \
            apt-get update && \
            ACCEPT_EULA=Y apt-get install -y mssql-tools unixodbc-dev && \
            echo 'export PATH=$PATH:/opt/mssql-tools/bin' >> /root/.bashrc \
            "

      - name: Copy database creation script into container
        run: |
          docker cp "${GITHUB_WORKSPACE}/Scripts/CreateAutopilotDatabases.sql" $CONTAINER_NAME:/tmp/CreateAutopilotDatabases.sql

      - name: Initialize database
        run: |
          docker exec $CONTAINER_NAME /opt/mssql-tools/bin/sqlcmd \
            -S localhost -U sa -P "$SA_PASSWORD" -i /tmp/CreateAutopilotDatabases.sql

      - name: Export connection info for Flyway
        run: |
          echo "dbUser=sa" >> "$GITHUB_ENV"
          echo "dbPassword=$SA_PASSWORD" >> "$GITHUB_ENV"
          echo "instance=localhost,$HOST_PORT" >> "$GITHUB_ENV"

  Validate-Flyway-Pipeline:
    name: Run Flyway Pipeline
    needs: setup-validation-environment
    uses: ./.github/workflows/GitHub-Flyway-CICD-StateBased-Pipeline_Linux.yml
    secrets: inherit

  cleanup:
    name: Cleanup SQL Server Container
    runs-on: "self-hosted"
    needs: Validate-Flyway-Pipeline
    if: always()
    env:
      CONTAINER_NAME: "${{ vars.CONTAINER_NAME }}-${{ github.run_number }}"
    steps:
      - name: Stop and remove container
        run: |
          echo "Cleaning up container $CONTAINER_NAME"
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
